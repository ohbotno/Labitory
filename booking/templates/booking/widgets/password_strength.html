<div class="password-input-container">
    <input type="password"{% if widget.attrs.id %} id="{{ widget.attrs.id }}"{% endif %} name="{{ widget.name }}"{% if widget.value %} value="{{ widget.value|stringformat:'s' }}"{% endif %}{% for name, value in widget.attrs.items %}{% if name != 'id' %} {{ name }}{% if value is not None %}="{{ value|stringformat:'s' }}"{% endif %}{% endif %}{% endfor %} />
    
    {% if widget.show_strength_meter %}
    <div class="password-strength-container mt-2">
        <div class="d-flex align-items-center">
            <small class="text-muted me-2">Strength:</small>
            <div class="progress flex-grow-1" style="height: 6px;">
                <div class="progress-bar" id="{{ widget.attrs.id }}-strength-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small class="ms-2 text-muted" id="{{ widget.attrs.id }}-strength-text">Weak</small>
        </div>
        <div class="password-feedback mt-1" id="{{ widget.attrs.id }}-feedback" style="display: none;">
            <ul class="list-unstyled small mb-0"></ul>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('{{ widget.attrs.id }}');
    const strengthBar = document.getElementById('{{ widget.attrs.id }}-strength-bar');
    const strengthText = document.getElementById('{{ widget.attrs.id }}-strength-text');
    const feedbackDiv = document.getElementById('{{ widget.attrs.id }}-feedback');
    const feedbackList = feedbackDiv ? feedbackDiv.querySelector('ul') : null;
    
    if (passwordInput && strengthBar && strengthText) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const strength = calculatePasswordStrength(password);
            
            // Update progress bar
            strengthBar.style.width = strength.score + '%';
            strengthBar.setAttribute('aria-valuenow', strength.score);
            
            // Update colors based on strength
            strengthBar.className = 'progress-bar bg-' + strength.color;
            
            // Update text
            strengthText.textContent = strength.strength + ' (' + strength.score + '/100)';
            strengthText.className = 'ms-2 text-' + strength.color;
            
            // Update feedback
            if (feedbackList && strength.feedback.length > 0) {
                feedbackList.innerHTML = '';
                strength.feedback.forEach(function(item) {
                    const li = document.createElement('li');
                    li.innerHTML = '<i class="bi bi-info-circle"></i> ' + item;
                    feedbackList.appendChild(li);
                });
                feedbackDiv.style.display = 'block';
            } else if (feedbackDiv) {
                feedbackDiv.style.display = 'none';
            }
        });
    }
    
    function calculatePasswordStrength(password) {
        let score = 0;
        let feedback = [];
        
        // Length scoring (0-30 points)
        const length = password.length;
        if (length >= 12) {
            score += 30;
            feedback.push('✓ Good length');
        } else if (length >= 8) {
            score += 20;
            feedback.push('⚠ Adequate length');
        } else if (length > 0) {
            score += 10;
            feedback.push('✗ Too short');
        }
        
        // Character variety (0-40 points)
        const hasLower = /[a-z]/.test(password);
        const hasUpper = /[A-Z]/.test(password);
        const hasDigit = /[0-9]/.test(password);
        const hasSymbol = /[!@#$%^&*(),.?":{}|<>]/.test(password);
        
        const varietyCount = [hasLower, hasUpper, hasDigit, hasSymbol].filter(Boolean).length;
        score += varietyCount * 10;
        
        if (varietyCount >= 4) {
            feedback.push('✓ Excellent character variety');
        } else if (varietyCount >= 3) {
            feedback.push('⚠ Good character variety');
        } else if (varietyCount > 0) {
            feedback.push('✗ Poor character variety');
        }
        
        // Uniqueness (0-20 points)
        const uniqueChars = new Set(password).size;
        if (password.length > 0) {
            const uniqueRatio = uniqueChars / password.length;
            if (uniqueRatio >= 0.75) {
                score += 20;
                feedback.push('✓ Good character uniqueness');
            } else if (uniqueRatio >= 0.5) {
                score += 10;
                feedback.push('⚠ Adequate character uniqueness');
            } else {
                feedback.push('✗ Too many repeated characters');
            }
        }
        
        // Penalty for common patterns (0-10 points deduction)
        if (/(?:012|123|234|345|456|567|678|789|890)/.test(password)) {
            score -= 5;
            feedback.push('✗ Contains sequential numbers');
        }
        
        if (/(.)\1{2,}/.test(password)) {
            score -= 5;
            feedback.push('✗ Contains repeated characters');
        }
        
        // Check for common words
        const commonWords = ['password', 'admin', 'user', 'login', 'welcome'];
        const lowerPassword = password.toLowerCase();
        for (const word of commonWords) {
            if (lowerPassword.includes(word)) {
                score -= 10;
                feedback.push('✗ Contains common words');
                break;
            }
        }
        
        // Ensure score is between 0-100
        score = Math.max(0, Math.min(100, score));
        
        // Determine strength level and color
        let strength, color;
        if (score >= 80) {
            strength = 'Very Strong';
            color = 'success';
        } else if (score >= 60) {
            strength = 'Strong';
            color = 'primary';
        } else if (score >= 40) {
            strength = 'Medium';
            color = 'warning';
        } else {
            strength = 'Weak';
            color = 'danger';
        }
        
        return {
            score: score,
            strength: strength,
            color: color,
            feedback: feedback
        };
    }
});
</script>

<style>
.password-input-container {
    position: relative;
}

.password-strength-container .progress {
    border-radius: 3px;
    background-color: #e9ecef;
}

.password-feedback {
    font-size: 0.875rem;
}

.password-feedback ul li {
    margin-bottom: 0.25rem;
}

.password-feedback .bi {
    margin-right: 0.25rem;
}
</style>