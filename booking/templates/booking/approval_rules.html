{% extends 'booking/base.html' %}
{% load static %}

{% block title %}Approval Rules - {{ lab_name }}{% endblock %}

{% block extra_css %}
<style>
.rules-list {
    background: var(--color-bg-primary);
    border-radius: 8px;
    border: 1px solid var(--color-border-light);
    overflow: hidden;
}

.rule-item {
    border-bottom: 1px solid var(--color-border-light);
    padding: 0.75rem 1rem;
    transition: background-color 0.2s ease;
    border-left: 3px solid var(--color-primary);
    display: flex;
    align-items: center;
    gap: 1rem;
    min-height: 3.5rem;
}
.rule-item:last-child {
    border-bottom: none;
}
.rule-item:hover {
    background-color: var(--color-bg-secondary);
}

.rule-auto { border-left-color: var(--color-success); }
.rule-single { border-left-color: var(--color-warning); }
.rule-tiered { border-left-color: var(--color-danger); }
.rule-quota { border-left-color: var(--color-info); }
.rule-conditional { border-left-color: var(--color-warning-hover); }

.rule-main-content {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 1rem;
    min-width: 0;
}

.rule-title {
    font-weight: 600;
    font-size: 1rem;
    margin: 0;
    min-width: 180px;
    flex-shrink: 0;
}

.rule-badges {
    display: flex;
    gap: 0.25rem;
    align-items: center;
    min-width: 200px;
}

.rule-badges .badge {
    font-size: 0.75rem;
    padding: 0.15rem 0.4rem;
    white-space: nowrap;
}

.rule-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
    font-size: 0.9rem;
    min-width: 0;
}

.rule-description {
    color: var(--color-text-secondary);
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 200px;
}

.rule-applies-to {
    display: flex;
    gap: 0.25rem;
    align-items: center;
    flex-shrink: 0;
}

.rule-applies-to strong {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-right: 0.25rem;
}

.rule-conditions {
    display: flex;
    gap: 0.2rem;
    align-items: center;
    flex-shrink: 0;
}

.rule-meta {
    display: flex;
    gap: 0.75rem;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    align-items: center;
    flex-shrink: 0;
    min-width: 220px;
}

.rule-meta span {
    display: flex;
    align-items: center;
    gap: 0.2rem;
    white-space: nowrap;
}

.rule-actions {
    display: flex;
    gap: 0.2rem;
    flex-shrink: 0;
}

.rule-actions .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    border-radius: 4px;
    min-width: auto;
}


.condition-badge {
    font-size: 0.7rem;
    padding: 0.15rem 0.35rem;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    font-weight: 500;
}
.condition-badge i {
    font-size: 0.65rem;
}
.condition-time { background-color: var(--color-info-lighter); color: var(--color-info-text); }
.condition-usage { background-color: var(--color-primary-lighter); color: var(--color-primary-active); }
.condition-training { background-color: var(--color-success-lighter); color: var(--color-success-text); }
.condition-role { background-color: var(--color-warning-lighter); color: var(--color-warning-text); }
.condition-resource { background-color: var(--color-danger-lighter); color: var(--color-danger-text); }


.compact-stats {
    margin-bottom: 2rem;
}
.compact-stats .card {
    border-radius: 10px;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.compact-stats .card-body {
    padding: 1rem;
}
.compact-stats h3 {
    font-size: 1.5rem;
    font-weight: 700;
}

.rule-builder {
    background-color: var(--color-bg-secondary);
    border: 2px dashed var(--color-border-light);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    margin-bottom: 1.25rem;
    transition: all 0.2s ease;
}
.rule-builder:hover {
    border-color: var(--color-primary);
    background-color: var(--color-primary-lighter);
    cursor: pointer;
}

.condition-builder {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border-light);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.filter-section {
    background: var(--color-bg-primary);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    margin-bottom: 2rem;
}

.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--color-text-secondary);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1><i class="fas fa-cogs me-2"></i>Approval Rules</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'booking:dashboard' %}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'booking:approval_dashboard' %}">Approvals</a></li>
                            <li class="breadcrumb-item active">Rules</li>
                        </ol>
                    </nav>
                </div>
                <div class="btn-group">
                    <a href="{% url 'booking:approval_statistics' %}" class="btn btn-outline-info">
                        <i class="fas fa-chart-line me-2"></i>View Statistics
                    </a>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRuleModal">
                        <i class="fas fa-plus me-2"></i>Create New Rule
                    </button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="row compact-stats">
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-double fa-lg me-3"></i>
                                <div>
                                    <h3 class="mb-0">{{ stats.auto_rules }}</h3>
                                    <small>Auto-Approval</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-check fa-lg me-3"></i>
                                <div>
                                    <h3 class="mb-0">{{ stats.manual_rules }}</h3>
                                    <small>Manual Approval</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-sitemap fa-lg me-3"></i>
                                <div>
                                    <h3 class="mb-0">{{ stats.conditional_rules }}</h3>
                                    <small>Conditional</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-secondary text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-toggle-on fa-lg me-3"></i>
                                <div>
                                    <h3 class="mb-0">{{ stats.active_rules }}</h3>
                                    <small>Active Rules</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="card filter-section">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Rule Type</label>
                            <select name="type" class="form-select">
                                <option value="">All Types</option>
                                <option value="auto" {% if request.GET.type == 'auto' %}selected{% endif %}>Auto-Approval</option>
                                <option value="single" {% if request.GET.type == 'single' %}selected{% endif %}>Single Approval</option>
                                <option value="tiered" {% if request.GET.type == 'tiered' %}selected{% endif %}>Tiered Approval</option>
                                <option value="quota" {% if request.GET.type == 'quota' %}selected{% endif %}>Quota-Based</option>
                                <option value="conditional" {% if request.GET.type == 'conditional' %}selected{% endif %}>Conditional</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Resource</label>
                            <select name="resource" class="form-select">
                                <option value="">All Resources</option>
                                {% for resource in resources %}
                                <option value="{{ resource.id }}" {% if request.GET.resource == resource.id|stringformat:"s" %}selected{% endif %}>
                                    {{ resource.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Search</label>
                            <input type="text" name="search" class="form-control" placeholder="Search rules by name or description..." value="{{ request.GET.search }}">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-outline-primary me-2">
                                <i class="fas fa-search"></i>
                            </button>
                            <a href="{% url 'booking:approval_rules' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Rules List -->
            {% if rules %}
            <div class="rules-list">
                {% for rule in rules %}
                <div class="rule-item rule-{{ rule.approval_type }}">
                    <div class="rule-main-content">
                        <div class="rule-title">{{ rule.name }}</div>

                        <div class="rule-badges">
                            {% if rule.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                            <span class="badge bg-primary">{{ rule.get_approval_type_display }}</span>
                            {% if rule.approval_type == 'conditional' %}
                            <span class="badge bg-warning">{{ rule.get_condition_type_display }}</span>
                            {% endif %}
                        </div>

                        <div class="rule-info">
                            {% if rule.description %}
                            <div class="rule-description" title="{{ rule.description }}">{{ rule.description }}</div>
                            {% endif %}

                            <div class="rule-applies-to">
                                <strong>Applies to:</strong>
                                {% if rule.resource %}
                                <span class="badge bg-light text-dark">{{ rule.resource.name }}</span>
                                {% else %}
                                <span class="badge bg-primary text-white">All Resources</span>
                                {% endif %}
                                {% if rule.user_roles %}
                                {% for role in rule.user_roles %}
                                <span class="badge bg-info">{{ role|title }}</span>
                                {% endfor %}
                                {% endif %}
                            </div>

                            {% if rule.approval_type == 'conditional' and rule.conditional_logic %}
                            <div class="rule-conditions">
                                {% for condition_type, condition_data in rule.conditional_logic.items %}
                                {% if condition_data %}
                                <span class="condition-badge condition-{{ condition_type }}">
                                    {% if condition_type == 'time_based' %}
                                    <i class="fas fa-clock"></i> Time
                                    {% elif condition_type == 'usage_based' %}
                                    <i class="fas fa-chart-line"></i> Usage
                                    {% elif condition_type == 'training_based' %}
                                    <i class="fas fa-graduation-cap"></i> Training
                                    {% elif condition_type == 'role_based' %}
                                    <i class="fas fa-user-tag"></i> Role
                                    {% elif condition_type == 'resource_based' %}
                                    <i class="fas fa-cog"></i> Resource
                                    {% endif %}
                                </span>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="rule-meta">
                            <span><i class="fas fa-sort-numeric-down"></i>{{ rule.priority }}</span>
                            <span><i class="fas fa-calendar-plus"></i>{{ rule.created_at|date:"M j" }}</span>
                            {% if rule.fallback_rule %}
                            <span><i class="fas fa-arrow-right"></i>{{ rule.fallback_rule.name|truncatechars:15 }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="rule-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="editRule({{ rule.id }})" title="Edit Rule">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="testRule({{ rule.id }})" title="Test Rule">
                            <i class="fas fa-play"></i>
                        </button>
                        {% if rule.is_active %}
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleRule({{ rule.id }}, false)" title="Disable Rule">
                            <i class="fas fa-pause"></i>
                        </button>
                        {% else %}
                        <button class="btn btn-sm btn-outline-success" onclick="toggleRule({{ rule.id }}, true)" title="Enable Rule">
                            <i class="fas fa-play"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="rule-builder" onclick="document.querySelector('[data-bs-target=&quot;#createRuleModal&quot;]').click()">
                    <i class="fas fa-plus-circle fa-3x text-muted mb-3"></i>
                    <h4>No Approval Rules Found</h4>
                    <p class="text-muted">Click here to create your first approval rule</p>
                </div>
            </div>
            {% endif %}

            <!-- Pagination -->
            {% if rules.has_other_pages %}
            <nav aria-label="Rules pagination">
                <ul class="pagination justify-content-center">
                    {% if rules.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET.type %}type={{ request.GET.type }}&{% endif %}{% if request.GET.resource %}resource={{ request.GET.resource }}&{% endif %}{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}page={{ rules.previous_page_number }}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for num in rules.paginator.page_range %}
                    {% if rules.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > rules.number|add:'-3' and num < rules.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET.type %}type={{ request.GET.type }}&{% endif %}{% if request.GET.resource %}resource={{ request.GET.resource }}&{% endif %}{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}
                    
                    {% if rules.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET.type %}type={{ request.GET.type }}&{% endif %}{% if request.GET.resource %}resource={{ request.GET.resource }}&{% endif %}{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}page={{ rules.next_page_number }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Create Rule Modal -->
<div class="modal fade" id="createRuleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Approval Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createRuleForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Rule Name *</label>
                                <input type="text" name="name" class="form-control" required placeholder="e.g., Auto-approve for trusted users">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Rule Type *</label>
                                <select name="approval_type" class="form-select" required onchange="toggleRuleOptions(this.value)">
                                    <option value="">Select rule type...</option>
                                    <option value="auto">Auto-Approval</option>
                                    <option value="single">Single Level Approval</option>
                                    <option value="tiered">Tiered Approval</option>
                                    <option value="quota">Quota-Based Approval</option>
                                    <option value="conditional">Conditional Approval</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2" placeholder="Describe when and how this rule applies..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Resource</label>
                                <select name="resource" class="form-select">
                                    <option value="">All Resources</option>
                                    {% for resource in resources %}
                                    <option value="{{ resource.id }}">{{ resource.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">User Role</label>
                                <select name="user_role" class="form-select">
                                    <option value="">All Roles</option>
                                    <option value="student">Student</option>
                                    <option value="researcher">Researcher</option>
                                    <option value="academic">Academic</option>
                                    <option value="technician">Technician</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <input type="number" name="priority" class="form-control" value="100" min="1" max="999">
                                <div class="form-text">Lower numbers = higher priority</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Fallback Rule</label>
                                <select name="fallback_rule" class="form-select">
                                    <option value="">No fallback</option>
                                    {% for existing_rule in all_rules %}
                                    <option value="{{ existing_rule.id }}">{{ existing_rule.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conditional Rule Options -->
                    <div id="conditionalOptions" style="display: none;">
                        <hr>
                        <h6><i class="fas fa-cogs me-2"></i>Conditional Logic</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Condition Type *</label>
                            <select name="condition_type" class="form-select" onchange="showConditionBuilder(this.value)">
                                <option value="">Select condition type...</option>
                                <option value="time_based">Time-Based Conditions</option>
                                <option value="usage_based">Usage-Based Conditions</option>
                                <option value="training_based">Training-Based Conditions</option>
                                <option value="role_based">Role-Based Conditions</option>
                                <option value="resource_based">Resource-Based Conditions</option>
                                <option value="custom">Custom Logic</option>
                            </select>
                        </div>
                        
                        <!-- Time-Based Conditions -->
                        <div id="timeConditions" class="condition-builder" style="display: none;">
                            <h6>Time-Based Conditions</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="time_business_hours" id="timeBusinessHours">
                                        <label class="form-check-label" for="timeBusinessHours">
                                            Only during business hours
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="time_advance_booking" id="timeAdvanceBooking">
                                        <label class="form-check-label" for="timeAdvanceBooking">
                                            Require advance booking
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <label class="form-label">Minimum advance (hours)</label>
                                        <input type="number" name="time_min_advance" class="form-control" value="24">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Maximum duration (hours)</label>
                                        <input type="number" name="time_max_duration" class="form-control" value="8">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Usage-Based Conditions -->
                        <div id="usageConditions" class="condition-builder" style="display: none;">
                            <h6>Usage-Based Conditions</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <label class="form-label">Max bookings per user per month</label>
                                        <input type="number" name="usage_max_monthly" class="form-control" value="10">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Max hours per user per week</label>
                                        <input type="number" name="usage_max_weekly_hours" class="form-control" value="20">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="usage_prevent_consecutive" id="usagePreventConsecutive">
                                        <label class="form-check-label" for="usagePreventConsecutive">
                                            Prevent consecutive bookings
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="usage_priority_returning" id="usagePriorityReturning">
                                        <label class="form-check-label" for="usagePriorityReturning">
                                            Priority for returning users
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Training-Based Conditions -->
                        <div id="trainingConditions" class="condition-builder" style="display: none;">
                            <h6>Training-Based Conditions</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="training_require_certification" id="trainingRequireCertification">
                                        <label class="form-check-label" for="trainingRequireCertification">
                                            Require valid certification
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="training_require_recent" id="trainingRequireRecent">
                                        <label class="form-check-label" for="trainingRequireRecent">
                                            Require recent training (within 12 months)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <label class="form-label">Minimum training level</label>
                                        <select name="training_min_level" class="form-select">
                                            <option value="basic">Basic</option>
                                            <option value="intermediate">Intermediate</option>
                                            <option value="advanced">Advanced</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quota Rule Options -->
                    <div id="quotaOptions" style="display: none;">
                        <hr>
                        <h6><i class="fas fa-chart-pie me-2"></i>Quota Configuration</h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Quota Type *</label>
                                    <select name="quota_type" class="form-select">
                                        <option value="time_based">Time-Based (hours)</option>
                                        <option value="booking_count">Booking Count</option>
                                        <option value="cost_based">Cost-Based</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Quota Amount *</label>
                                    <input type="number" name="quota_amount" class="form-control" step="0.5" min="0" placeholder="e.g., 40 (hours/count/cost)">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Period Type *</label>
                                    <select name="quota_period" class="form-select">
                                        <option value="monthly">Monthly</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="daily">Daily</option>
                                        <option value="academic_year">Academic Year</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Max Overdraft</label>
                                    <input type="number" name="max_overdraft" class="form-control" step="0.5" min="0" value="0" placeholder="Additional amount allowed">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="auto_approve_within_quota" id="autoApproveWithinQuota" checked>
                                    <label class="form-check-label" for="autoApproveWithinQuota">
                                        Auto-approve within quota
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="require_approval_over_quota" id="requireApprovalOverQuota" checked>
                                    <label class="form-check-label" for="requireApprovalOverQuota">
                                        Require approval when over quota
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="allow_overdraft" id="allowOverdraft">
                                    <label class="form-check-label" for="allowOverdraft">
                                        Allow overdraft usage
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="rollover_unused" id="rolloverUnused">
                                    <label class="form-check-label" for="rolloverUnused">
                                        Rollover unused quota
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Scope</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="quota_scope" value="all_users" id="quotaScopeAll" checked>
                                        <label class="form-check-label" for="quotaScopeAll">All Users</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="quota_scope" value="role_based" id="quotaScopeRole">
                                        <label class="form-check-label" for="quotaScopeRole">By User Role</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="quota_scope" value="specific_users" id="quotaScopeUsers">
                                        <label class="form-check-label" for="quotaScopeUsers">Specific Users</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tiered Approval Options -->
                    <div id="tieredOptions" style="display: none;">
                        <hr>
                        <h6><i class="fas fa-sitemap me-2"></i>Tiered Approval Configuration</h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tier Mode *</label>
                                    <select name="tier_mode" class="form-select">
                                        <option value="sequential">Sequential (one after another)</option>
                                        <option value="parallel">Parallel (all at same time)</option>
                                        <option value="escalating">Escalating (timeout based)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Default Timeout (hours)</label>
                                    <input type="number" name="tier_timeout_hours" class="form-control" value="48" min="1" max="168">
                                    <div class="form-text">Time before escalating to next tier</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="tier_escalation_enabled" id="tierEscalationEnabled">
                            <label class="form-check-label" for="tierEscalationEnabled">
                                Enable automatic escalation on timeout
                            </label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Primary Approvers</label>
                            <select name="primary_approvers" class="form-select" multiple size="4">
                                {% for user in lab_admins %}
                                <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple approvers</div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Additional tiers and specific approver assignments can be configured after creating the rule.
                        </div>
                    </div>

                    <!-- Single Approval Options -->
                    <div id="singleOptions" style="display: none;">
                        <hr>
                        <h6><i class="fas fa-user-check me-2"></i>Single Approval Configuration</h6>

                        <div class="mb-3">
                            <label class="form-label">Approvers *</label>
                            <select name="single_approvers" class="form-select" multiple size="5" required>
                                {% for user in lab_admins %}
                                <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Select one or more users who can approve requests. Hold Ctrl/Cmd to select multiple.</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="allow_delegation" id="allowDelegation" checked>
                                    <label class="form-check-label" for="allowDelegation">
                                        Allow approval delegation
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="require_comments" id="requireComments">
                                    <label class="form-check-label" for="requireComments">
                                        Require approval comments
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Approval Timeout (hours)</label>
                                    <input type="number" name="single_timeout_hours" class="form-control" value="72" min="1" max="168">
                                    <div class="form-text">Time before request expires</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Assignment Method</label>
                            <select name="assignment_method" class="form-select">
                                <option value="any">Any selected approver can approve</option>
                                <option value="round_robin">Round-robin assignment</option>
                                <option value="load_balanced">Load-balanced assignment</option>
                                <option value="all_required">All selected approvers required</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Rule</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Edit Rule Modal -->
<div class="modal fade" id="editRuleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Approval Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editRuleForm" method="post">
                {% csrf_token %}
                <input type="hidden" name="rule_id" id="editRuleId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Rule Name *</label>
                                <input type="text" name="name" id="editRuleName" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Rule Type *</label>
                                <select name="approval_type" id="editRuleType" class="form-select" required onchange="toggleEditRuleOptions(this.value)">
                                    <option value="auto">Auto-Approval</option>
                                    <option value="single">Single Level Approval</option>
                                    <option value="tiered">Tiered Approval</option>
                                    <option value="quota">Quota-Based Approval</option>
                                    <option value="conditional">Conditional Approval</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" id="editRuleDescription" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Resource</label>
                                <select name="resource" id="editRuleResource" class="form-select">
                                    <option value="">All Resources</option>
                                    {% for resource in resources %}
                                    <option value="{{ resource.id }}">{{ resource.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">User Role</label>
                                <select name="user_role" id="editRuleUserRole" class="form-select">
                                    <option value="">All Roles</option>
                                    <option value="student">Student</option>
                                    <option value="researcher">Researcher</option>
                                    <option value="academic">Academic</option>
                                    <option value="technician">Technician</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <input type="number" name="priority" id="editRulePriority" class="form-control" min="1" max="999">
                                <div class="form-text">Lower numbers = higher priority</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Active</label>
                                <select name="is_active" id="editRuleActive" class="form-select">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Conditional Rule Options for Edit -->
                    <div id="editConditionalOptions" style="display: none;">
                        <hr>
                        <h6><i class="fas fa-cogs me-2"></i>Conditional Logic</h6>

                        <div class="mb-3">
                            <label class="form-label">Condition Type *</label>
                            <select name="condition_type" id="editConditionType" class="form-select" onchange="showEditConditionBuilder(this.value)">
                                <option value="">Select condition type...</option>
                                <option value="time_based">Time-Based Conditions</option>
                                <option value="usage_based">Usage-Based Conditions</option>
                                <option value="training_based">Training-Based Conditions</option>
                                <option value="role_based">Role-Based Conditions</option>
                                <option value="resource_based">Resource-Based Conditions</option>
                                <option value="custom">Custom Logic</option>
                            </select>
                        </div>

                        <!-- Time-Based Conditions for Edit -->
                        <div id="editTimeConditions" class="condition-builder" style="display: none;">
                            <h6>Time-Based Conditions</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="time_business_hours" id="editTimeBusinessHours">
                                        <label class="form-check-label" for="editTimeBusinessHours">
                                            Only during business hours
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="time_advance_booking" id="editTimeAdvanceBooking">
                                        <label class="form-check-label" for="editTimeAdvanceBooking">
                                            Require advance booking
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <label class="form-label">Minimum advance (hours)</label>
                                        <input type="number" name="time_min_advance" id="editTimeMinAdvance" class="form-control" value="24">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Maximum duration (hours)</label>
                                        <input type="number" name="time_max_duration" id="editTimeMaxDuration" class="form-control" value="8">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Usage-Based Conditions for Edit -->
                        <div id="editUsageConditions" class="condition-builder" style="display: none;">
                            <h6>Usage-Based Conditions</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <label class="form-label">Max bookings per user per month</label>
                                        <input type="number" name="usage_max_monthly" id="editUsageMaxMonthly" class="form-control" value="10">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Max hours per user per week</label>
                                        <input type="number" name="usage_max_weekly_hours" id="editUsageMaxWeeklyHours" class="form-control" value="20">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="usage_prevent_consecutive" id="editUsagePreventConsecutive">
                                        <label class="form-check-label" for="editUsagePreventConsecutive">
                                            Prevent consecutive bookings
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="usage_priority_returning" id="editUsagePriorityReturning">
                                        <label class="form-check-label" for="editUsagePriorityReturning">
                                            Priority for returning users
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Training-Based Conditions for Edit -->
                        <div id="editTrainingConditions" class="condition-builder" style="display: none;">
                            <h6>Training-Based Conditions</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="training_require_certification" id="editTrainingRequireCertification">
                                        <label class="form-check-label" for="editTrainingRequireCertification">
                                            Require valid certification
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="training_require_recent" id="editTrainingRequireRecent">
                                        <label class="form-check-label" for="editTrainingRequireRecent">
                                            Require recent training (within 12 months)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <label class="form-label">Minimum training level</label>
                                        <select name="training_min_level" id="editTrainingMinLevel" class="form-select">
                                            <option value="basic">Basic</option>
                                            <option value="intermediate">Intermediate</option>
                                            <option value="advanced">Advanced</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Rule</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleRuleOptions(ruleType) {
    // Get all option sections
    const conditionalOptions = document.getElementById('conditionalOptions');
    const quotaOptions = document.getElementById('quotaOptions');
    const tieredOptions = document.getElementById('tieredOptions');
    const singleOptions = document.getElementById('singleOptions');

    // Hide all sections first
    conditionalOptions.style.display = 'none';
    quotaOptions.style.display = 'none';
    tieredOptions.style.display = 'none';
    singleOptions.style.display = 'none';

    // Show the relevant section based on rule type
    switch(ruleType) {
        case 'conditional':
            conditionalOptions.style.display = 'block';
            break;
        case 'quota':
            quotaOptions.style.display = 'block';
            break;
        case 'tiered':
            tieredOptions.style.display = 'block';
            break;
        case 'single':
            singleOptions.style.display = 'block';
            break;
        // 'auto' doesn't need additional configuration
    }
}

function showConditionBuilder(conditionType) {
    // Hide all condition builders
    document.getElementById('timeConditions').style.display = 'none';
    document.getElementById('usageConditions').style.display = 'none';
    document.getElementById('trainingConditions').style.display = 'none';
    
    // Show the selected condition builder
    if (conditionType === 'time_based') {
        document.getElementById('timeConditions').style.display = 'block';
    } else if (conditionType === 'usage_based') {
        document.getElementById('usageConditions').style.display = 'block';
    } else if (conditionType === 'training_based') {
        document.getElementById('trainingConditions').style.display = 'block';
    }
}

function editRule(ruleId) {
    // Fetch rule data from the server
    fetch(`/lab-admin/approval-rules/${ruleId}/edit/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const rule = data.rule;

            // Populate the edit form
            document.getElementById('editRuleId').value = rule.id;
            document.getElementById('editRuleName').value = rule.name || '';
            document.getElementById('editRuleType').value = rule.approval_type || '';
            document.getElementById('editRuleDescription').value = rule.description || '';
            document.getElementById('editRuleResource').value = rule.resource_id || '';
            document.getElementById('editRuleUserRole').value = rule.user_role || '';
            document.getElementById('editRulePriority').value = rule.priority || 100;
            document.getElementById('editRuleActive').value = rule.is_active ? 'true' : 'false';

            // Handle conditional logic
            toggleEditRuleOptions(rule.approval_type);
            if (rule.approval_type === 'conditional' && rule.conditional_logic) {
                document.getElementById('editConditionType').value = rule.condition_type || '';
                showEditConditionBuilder(rule.condition_type);

                // Populate conditional logic fields based on type
                const logic = rule.conditional_logic;
                if (rule.condition_type === 'time_based' && logic.time_based) {
                    const timeLogic = logic.time_based;
                    document.getElementById('editTimeBusinessHours').checked = timeLogic.business_hours_only || false;
                    document.getElementById('editTimeAdvanceBooking').checked = timeLogic.require_advance_booking || false;
                    document.getElementById('editTimeMinAdvance').value = timeLogic.min_advance_hours || 24;
                    document.getElementById('editTimeMaxDuration').value = timeLogic.max_duration_hours || 8;
                } else if (rule.condition_type === 'usage_based' && logic.usage_based) {
                    const usageLogic = logic.usage_based;
                    document.getElementById('editUsageMaxMonthly').value = usageLogic.max_monthly_bookings || 10;
                    document.getElementById('editUsageMaxWeeklyHours').value = usageLogic.max_weekly_hours || 20;
                    document.getElementById('editUsagePreventConsecutive').checked = usageLogic.prevent_consecutive || false;
                    document.getElementById('editUsagePriorityReturning').checked = usageLogic.priority_returning_users || false;
                } else if (rule.condition_type === 'training_based' && logic.training_based) {
                    const trainingLogic = logic.training_based;
                    document.getElementById('editTrainingRequireCertification').checked = trainingLogic.require_certification || false;
                    document.getElementById('editTrainingRequireRecent').checked = trainingLogic.require_recent_training || false;
                    document.getElementById('editTrainingMinLevel').value = trainingLogic.min_training_level || 'basic';
                }
            }

            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editRuleModal'));
            editModal.show();
        } else {
            alert('Error loading rule data: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading rule data');
    });
}

function toggleEditRuleOptions(ruleType) {
    // Get all edit option sections
    const conditionalOptions = document.getElementById('editConditionalOptions');
    const quotaOptions = document.getElementById('editQuotaOptions');
    const tieredOptions = document.getElementById('editTieredOptions');
    const singleOptions = document.getElementById('editSingleOptions');

    // Hide all sections first
    if (conditionalOptions) conditionalOptions.style.display = 'none';
    if (quotaOptions) quotaOptions.style.display = 'none';
    if (tieredOptions) tieredOptions.style.display = 'none';
    if (singleOptions) singleOptions.style.display = 'none';

    // Show the relevant section based on rule type
    switch(ruleType) {
        case 'conditional':
            if (conditionalOptions) conditionalOptions.style.display = 'block';
            break;
        case 'quota':
            if (quotaOptions) quotaOptions.style.display = 'block';
            break;
        case 'tiered':
            if (tieredOptions) tieredOptions.style.display = 'block';
            break;
        case 'single':
            if (singleOptions) singleOptions.style.display = 'block';
            break;
        // 'auto' doesn't need additional configuration
    }
}

function showEditConditionBuilder(conditionType) {
    // Hide all condition builders
    document.getElementById('editTimeConditions').style.display = 'none';
    document.getElementById('editUsageConditions').style.display = 'none';
    document.getElementById('editTrainingConditions').style.display = 'none';

    // Show the selected condition builder
    if (conditionType === 'time_based') {
        document.getElementById('editTimeConditions').style.display = 'block';
    } else if (conditionType === 'usage_based') {
        document.getElementById('editUsageConditions').style.display = 'block';
    } else if (conditionType === 'training_based') {
        document.getElementById('editTrainingConditions').style.display = 'block';
    }
}

function testRule(ruleId) {
    alert('Test functionality would simulate rule evaluation for rule ' + ruleId);
}

function toggleRule(ruleId, activate) {
    if (confirm(`Are you sure you want to ${activate ? 'enable' : 'disable'} this rule?`)) {
        fetch(`/lab-admin/approval-rules/${ruleId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({active: activate})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

// Form validation and submission
document.getElementById('createRuleForm').addEventListener('submit', function(e) {
    const ruleType = this.approval_type.value;
    const conditionType = this.condition_type?.value;
    
    if (ruleType === 'conditional' && !conditionType) {
        e.preventDefault();
        alert('Please select a condition type for conditional rules');
        return;
    }
    
    // Build conditional logic object
    if (ruleType === 'conditional') {
        const conditionalLogic = {};
        
        if (conditionType === 'time_based') {
            conditionalLogic.time_based = {
                business_hours_only: this.time_business_hours?.checked || false,
                require_advance_booking: this.time_advance_booking?.checked || false,
                min_advance_hours: parseInt(this.time_min_advance?.value) || 24,
                max_duration_hours: parseInt(this.time_max_duration?.value) || 8,
            };
        } else if (conditionType === 'usage_based') {
            conditionalLogic.usage_based = {
                max_monthly_bookings: parseInt(this.usage_max_monthly?.value) || 10,
                max_weekly_hours: parseInt(this.usage_max_weekly_hours?.value) || 20,
                prevent_consecutive: this.usage_prevent_consecutive?.checked || false,
                priority_returning_users: this.usage_priority_returning?.checked || false,
            };
        } else if (conditionType === 'training_based') {
            conditionalLogic.training_based = {
                require_certification: this.training_require_certification?.checked || false,
                require_recent_training: this.training_require_recent?.checked || false,
                min_training_level: this.training_min_level?.value || 'basic',
            };
        }
        
        // Add hidden field with conditional logic JSON
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = 'conditional_logic';
        hiddenField.value = JSON.stringify(conditionalLogic);
        this.appendChild(hiddenField);
    }
});

// Edit form submission
document.getElementById('editRuleForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // Collect conditional logic data for edit form
    const approvalType = this.approval_type?.value;
    const conditionType = this.condition_type?.value;

    if (approvalType === 'conditional' && conditionType) {
        let conditionalLogic = {};

        if (conditionType === 'time_based') {
            conditionalLogic.time_based = {
                business_hours_only: this.time_business_hours?.checked || false,
                require_advance_booking: this.time_advance_booking?.checked || false,
                min_advance_hours: parseInt(this.time_min_advance?.value) || 24,
                max_duration_hours: parseInt(this.time_max_duration?.value) || 8,
            };
        } else if (conditionType === 'usage_based') {
            conditionalLogic.usage_based = {
                max_monthly_bookings: parseInt(this.usage_max_monthly?.value) || 10,
                max_weekly_hours: parseInt(this.usage_max_weekly_hours?.value) || 20,
                prevent_consecutive: this.usage_prevent_consecutive?.checked || false,
                priority_returning_users: this.usage_priority_returning?.checked || false,
            };
        } else if (conditionType === 'training_based') {
            conditionalLogic.training_based = {
                require_certification: this.training_require_certification?.checked || false,
                require_recent_training: this.training_require_recent?.checked || false,
                min_training_level: this.training_min_level?.value || 'basic',
            };
        }

        // Add hidden field with conditional logic JSON
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = 'conditional_logic';
        hiddenField.value = JSON.stringify(conditionalLogic);
        this.appendChild(hiddenField);
    }

    const formData = new FormData(this);
    const ruleId = formData.get('rule_id');

    fetch(`/lab-admin/approval-rules/${ruleId}/update/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close the modal
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editRuleModal'));
            editModal.hide();

            // Reload the page to show updated data
            location.reload();
        } else {
            alert('Error updating rule: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating rule');
    });
});
</script>
{% endblock %}
