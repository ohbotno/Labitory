{% extends 'booking/base.html' %}
{% load static %}

{% block title %}{{ title }} - Site Administration{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">
                    <i class="fas fa-sms me-2"></i>
                    {{ title }}
                </h1>
                <div>
                    <a href="{% url 'booking:site_admin_sms_config' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Back to SMS Configuration
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Configuration Details
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-info-circle me-2"></i>Basic Information
                                </h6>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">
                                        Configuration Name <span class="text-danger">*</span>
                                    </label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.name.errors.0 }}
                                        </div>
                                    {% endif %}
                                    {% if form.name.help_text %}
                                        <div class="form-text">{{ form.name.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check">
                                            {{ form.is_active }}
                                            <label for="{{ form.is_active.id_for_label }}" class="form-check-label">
                                                Active Configuration
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            {{ form.is_enabled }}
                                            <label for="{{ form.is_enabled.id_for_label }}" class="form-check-label">
                                                SMS Enabled
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-text">
                                        Active: This configuration will be used for SMS. Enabled: SMS notifications are allowed.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                                    {{ form.description }}
                                    {% if form.description.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.description.errors.0 }}
                                        </div>
                                    {% endif %}
                                    {% if form.description.help_text %}
                                        <div class="form-text">{{ form.description.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Twilio Configuration -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fab fa-twilio me-2"></i>Twilio Configuration
                                </h6>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.twilio_account_sid.id_for_label }}" class="form-label">
                                        Account SID <span class="text-danger">*</span>
                                    </label>
                                    {{ form.twilio_account_sid }}
                                    {% if form.twilio_account_sid.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.twilio_account_sid.errors.0 }}
                                        </div>
                                    {% endif %}
                                    {% if form.twilio_account_sid.help_text %}
                                        <div class="form-text">{{ form.twilio_account_sid.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.twilio_auth_token.id_for_label }}" class="form-label">
                                        Auth Token <span class="text-danger">*</span>
                                    </label>
                                    {{ form.twilio_auth_token }}
                                    {% if form.twilio_auth_token.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.twilio_auth_token.errors.0 }}
                                        </div>
                                    {% endif %}
                                    {% if form.twilio_auth_token.help_text %}
                                        <div class="form-text">{{ form.twilio_auth_token.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="{{ form.twilio_phone_number.id_for_label }}" class="form-label">
                                        Phone Number <span class="text-danger">*</span>
                                    </label>
                                    {{ form.twilio_phone_number }}
                                    {% if form.twilio_phone_number.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.twilio_phone_number.errors.0 }}
                                        </div>
                                    {% endif %}
                                    {% if form.twilio_phone_number.help_text %}
                                        <div class="form-text">{{ form.twilio_phone_number.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-cogs me-2"></i>Advanced Settings
                                </h6>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.message_character_limit.id_for_label }}" class="form-label">
                                        Message Character Limit
                                    </label>
                                    {{ form.message_character_limit }}
                                    {% if form.message_character_limit.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.message_character_limit.errors.0 }}
                                        </div>
                                    {% endif %}
                                    {% if form.message_character_limit.help_text %}
                                        <div class="form-text">{{ form.message_character_limit.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.retry_count.id_for_label }}" class="form-label">
                                        Retry Count
                                    </label>
                                    {{ form.retry_count }}
                                    {% if form.retry_count.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.retry_count.errors.0 }}
                                        </div>
                                    {% endif %}
                                    {% if form.retry_count.help_text %}
                                        <div class="form-text">{{ form.retry_count.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        {% if config %}
                                            <button type="button" class="btn btn-outline-info me-2" onclick="showTestModal()">
                                                <i class="fas fa-flask me-2"></i>
                                                Test Configuration
                                            </button>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <a href="{% url 'booking:site_admin_sms_config' %}" class="btn btn-secondary me-2">
                                            Cancel
                                        </a>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>
                                            {% if config %}Update{% else %}Create{% endif %} Configuration
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Help Panel -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-question-circle me-2"></i>
                        Help & Tips
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6><i class="fas fa-key me-2"></i>Finding Your Credentials</h6>
                        <p class="small text-muted mb-2">
                            Your Twilio credentials are available in your <a href="https://console.twilio.com/" target="_blank">Twilio Console</a>:
                        </p>
                        <ul class="small text-muted">
                            <li><strong>Account SID</strong>: Found on your account dashboard</li>
                            <li><strong>Auth Token</strong>: Click "show" next to Auth Token</li>
                            <li><strong>Phone Number</strong>: From your phone numbers list</li>
                        </ul>
                    </div>

                    <div class="mb-4">
                        <h6><i class="fas fa-shield-alt me-2"></i>Security</h6>
                        <p class="small text-muted">
                            Your auth token is stored securely and encrypted. Only administrators 
                            can view or modify SMS configurations.
                        </p>
                    </div>

                    <div class="mb-4">
                        <h6><i class="fas fa-money-bill me-2"></i>Costs</h6>
                        <p class="small text-muted">
                            SMS messages have costs associated with them. Check your 
                            <a href="https://www.twilio.com/sms/pricing" target="_blank">Twilio pricing</a> 
                            for your region.
                        </p>
                    </div>

                    <div>
                        <h6><i class="fas fa-cog me-2"></i>Configuration Tips</h6>
                        <ul class="small text-muted">
                            <li>Test your configuration before activating</li>
                            <li>Keep message limits reasonable (1600 chars max)</li>
                            <li>Set retry count between 1-3 attempts</li>
                            <li>Use descriptive names for multiple configs</li>
                        </ul>
                    </div>
                </div>
            </div>

            {% if config and config.last_test_date %}
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>
                        Last Test Result
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        {% if config.is_validated %}
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span class="text-success">Success</span>
                        {% else %}
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            <span class="text-danger">Failed</span>
                        {% endif %}
                        <small class="text-muted ms-auto">{{ config.last_test_date|date:"M j, Y H:i" }}</small>
                    </div>
                    <p class="small mb-0">{{ config.last_test_result }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Test SMS Modal -->
{% if config %}
<div class="modal fade" id="testSMSModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test SMS Configuration: {{ config.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testSMSForm">
                    <input type="hidden" name="config_id" value="{{ config.id }}">
                    
                    <div class="mb-3">
                        <label for="testType" class="form-label">Test Type</label>
                        <select class="form-control" id="testType" name="test_type" onchange="togglePhoneField()">
                            <option value="validate">Validate Credentials Only</option>
                            <option value="send_sms">Send Test SMS</option>
                        </select>
                        <div class="form-text">Choose whether to validate credentials or send an actual SMS.</div>
                    </div>
                    
                    <div class="mb-3" id="phoneNumberField" style="display: none;">
                        <label for="testPhoneNumber" class="form-label">Test Phone Number</label>
                        <input type="tel" class="form-control" id="testPhoneNumber" name="test_phone_number" 
                               placeholder="+1234567890" pattern="^\+[1-9]\d{1,14}$">
                        <div class="form-text">Phone number in international format (+1234567890).</div>
                    </div>
                    
                    <div id="testResult" class="mt-3" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="runSMSTest()">
                    <span id="testSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                    Run Test
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function showTestModal() {
    document.getElementById('testResult').style.display = 'none';
    document.getElementById('testType').value = 'validate';
    togglePhoneField();
    new bootstrap.Modal(document.getElementById('testSMSModal')).show();
}

function togglePhoneField() {
    const testType = document.getElementById('testType').value;
    const phoneField = document.getElementById('phoneNumberField');
    const phoneInput = document.getElementById('testPhoneNumber');
    
    if (testType === 'send_sms') {
        phoneField.style.display = 'block';
        phoneInput.required = true;
    } else {
        phoneField.style.display = 'none';
        phoneInput.required = false;
    }
}

function runSMSTest() {
    const form = document.getElementById('testSMSForm');
    const formData = new FormData(form);
    const spinner = document.getElementById('testSpinner');
    const resultDiv = document.getElementById('testResult');
    
    spinner.style.display = 'inline-block';
    resultDiv.style.display = 'none';
    
    fetch('{% url "booking:site_admin_sms_config" %}?action=test', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        spinner.style.display = 'none';
        resultDiv.innerHTML = `
            <div class="alert alert-${data.success ? 'success' : 'danger'}">
                <i class="fas fa-${data.success ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${data.message}
            </div>
        `;
        resultDiv.style.display = 'block';
    })
    .catch(error => {
        spinner.style.display = 'none';
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Test failed: ${error.message}
            </div>
        `;
        resultDiv.style.display = 'block';
    });
}
</script>
{% endif %}
{% endblock %}