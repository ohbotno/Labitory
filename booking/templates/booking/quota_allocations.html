{% extends "booking/base.html" %}
{% load static %}

{% block title %}Quota Allocations - {{ lab_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Quota Allocations
                </h1>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuotaModal">
                    <i class="fas fa-plus me-2"></i>Add Quota Allocation
                </button>
            </div>

            <!-- Quota Allocations Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Current Quota Allocations</h5>
                </div>
                <div class="card-body">
                    {% if quota_allocations %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Period</th>
                                        <th>Resource</th>
                                        <th>Target</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for quota in quota_allocations %}
                                    <tr>
                                        <td>
                                            <strong>{{ quota.name }}</strong>
                                            {% if quota.description %}
                                                <br><small class="text-muted">{{ quota.description }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ quota.get_quota_type_display }}</span>
                                        </td>
                                        <td>
                                            {% if quota.quota_type == 'time' %}
                                                {{ quota.quota_amount }} hours
                                            {% elif quota.quota_type == 'count' %}
                                                {{ quota.quota_amount }} bookings
                                            {% else %}
                                                {{ quota.quota_amount }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ quota.get_period_type_display }}</span>
                                        </td>
                                        <td>
                                            {% if quota.resource %}
                                                {{ quota.resource.name }}
                                            {% else %}
                                                <span class="text-muted">All Resources</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if quota.user %}
                                                <i class="fas fa-user me-1"></i>{{ quota.user.get_full_name|default:quota.user.username }}
                                            {% elif quota.role %}
                                                <i class="fas fa-users me-1"></i>{{ quota.get_role_display }}
                                            {% else %}
                                                <span class="text-muted">Global</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if quota.is_active %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-danger">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary"
                                                        onclick="editQuota({{ quota.id }})" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-info"
                                                        onclick="viewQuotaUsage({{ quota.id }})" title="View Usage">
                                                    <i class="fas fa-chart-bar"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger"
                                                        onclick="deleteQuota({{ quota.id }})" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                            <h5>No Quota Allocations</h5>
                            <p class="text-muted">No quota allocations have been configured yet.</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuotaModal">
                                <i class="fas fa-plus me-2"></i>Add First Quota Allocation
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- User Quota Status Overview -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">User Quota Status Overview</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for status in user_quota_status %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">{{ status.user.get_full_name|default:status.user.username }}</h6>
                                    {% for quota in status.quotas %}
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">{{ quota.allocation.name }}</small>
                                            <span class="badge {% if quota.usage_percentage > 90 %}bg-danger{% elif quota.usage_percentage > 75 %}bg-warning{% else %}bg-success{% endif %}">
                                                {{ quota.usage_percentage|floatformat:0 }}%
                                            </span>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar {% if quota.usage_percentage > 90 %}bg-danger{% elif quota.usage_percentage > 75 %}bg-warning{% else %}bg-success{% endif %}"
                                                 role="progressbar" style="width: {{ quota.usage_percentage }}%"></div>
                                        </div>
                                        <small class="text-muted">
                                            {{ quota.used_amount|floatformat:1 }} / {{ quota.allocated_amount|floatformat:1 }}
                                            {% if quota.allocation.quota_type == 'time' %}hours{% elif quota.allocation.quota_type == 'count' %}bookings{% endif %}
                                        </small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="text-center py-3">
                                <p class="text-muted">No user quota data available</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Quota Modal -->
<div class="modal fade" id="addQuotaModal" tabindex="-1" aria-labelledby="addQuotaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addQuotaModalLabel">Add Quota Allocation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="quotaForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quotaName" class="form-label">Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="quotaName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quotaType" class="form-label">Quota Type <span class="text-danger">*</span></label>
                                <select class="form-select" id="quotaType" name="quota_type" required>
                                    <option value="">Select type...</option>
                                    <option value="time">Time-based</option>
                                    <option value="count">Count-based</option>
                                    <option value="cost">Cost-based</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quotaAmount" class="form-label">Quota Amount <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="quotaAmount" name="quota_amount"
                                       step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="periodType" class="form-label">Period Type <span class="text-danger">*</span></label>
                                <select class="form-select" id="periodType" name="period_type" required>
                                    <option value="">Select period...</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="quotaDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="quotaDescription" name="description" rows="2"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quotaResource" class="form-label">Resource (Optional)</label>
                                <select class="form-select" id="quotaResource" name="resource">
                                    <option value="">All resources</option>
                                    {% for resource in resources %}
                                    <option value="{{ resource.id }}">{{ resource.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="allowOverdraft" class="form-label">Allow Overdraft</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="allowOverdraft" name="allow_overdraft">
                                    <label class="form-check-label" for="allowOverdraft">
                                        Allow users to exceed quota limits
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Assignment Target</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="target_type" id="targetGlobal" value="global" checked>
                                    <label class="form-check-label" for="targetGlobal">
                                        Global (All Users)
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="target_type" id="targetRole" value="role">
                                    <label class="form-check-label" for="targetRole">
                                        By Role
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="target_type" id="targetUser" value="user">
                                    <label class="form-check-label" for="targetUser">
                                        Specific User
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="roleSelection" class="mb-3" style="display: none;">
                        <label for="quotaRole" class="form-label">Role</label>
                        <select class="form-select" id="quotaRole" name="role">
                            <option value="">Select role...</option>
                            <option value="student">Student</option>
                            <option value="staff">Staff</option>
                            <option value="researcher">Researcher</option>
                            <option value="external">External</option>
                        </select>
                    </div>

                    <div id="userSelection" class="mb-3" style="display: none;">
                        <label for="quotaUser" class="form-label">User</label>
                        <select class="form-select" id="quotaUser" name="user">
                            <option value="">Select user...</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }} ({{ user.email }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="isActive" name="is_active" checked>
                        <label class="form-check-label" for="isActive">
                            Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Quota Allocation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quota Usage Modal -->
<div class="modal fade" id="quotaUsageModal" tabindex="-1" aria-labelledby="quotaUsageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quotaUsageModalLabel">Quota Usage Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="quotaUsageContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Target type radio button handling
    const targetRadios = document.querySelectorAll('input[name="target_type"]');
    const roleSelection = document.getElementById('roleSelection');
    const userSelection = document.getElementById('userSelection');

    targetRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            roleSelection.style.display = this.value === 'role' ? 'block' : 'none';
            userSelection.style.display = this.value === 'user' ? 'block' : 'none';

            if (this.value !== 'role') {
                document.getElementById('quotaRole').value = '';
            }
            if (this.value !== 'user') {
                document.getElementById('quotaUser').value = '';
            }
        });
    });

    // Form submission
    document.getElementById('quotaForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Failed to save quota allocation'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the quota allocation');
        });
    });
});

function editQuota(quotaId) {
    // Load quota data and populate form
    fetch(`/lab-admin/quota-allocations/${quotaId}/edit/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const quota = data.quota;
                document.getElementById('quotaName').value = quota.name;
                document.getElementById('quotaType').value = quota.quota_type;
                document.getElementById('quotaAmount').value = quota.quota_amount;
                document.getElementById('periodType').value = quota.period_type;
                document.getElementById('quotaDescription').value = quota.description || '';
                document.getElementById('quotaResource').value = quota.resource || '';
                document.getElementById('allowOverdraft').checked = quota.allow_overdraft;
                document.getElementById('isActive').checked = quota.is_active;

                // Set target type
                if (quota.user) {
                    document.getElementById('targetUser').checked = true;
                    document.getElementById('quotaUser').value = quota.user;
                    document.getElementById('userSelection').style.display = 'block';
                } else if (quota.role) {
                    document.getElementById('targetRole').checked = true;
                    document.getElementById('quotaRole').value = quota.role;
                    document.getElementById('roleSelection').style.display = 'block';
                } else {
                    document.getElementById('targetGlobal').checked = true;
                }

                document.getElementById('addQuotaModalLabel').textContent = 'Edit Quota Allocation';
                document.getElementById('quotaForm').action = `/lab-admin/quota-allocations/${quotaId}/edit/`;

                new bootstrap.Modal(document.getElementById('addQuotaModal')).show();
            }
        });
}

function viewQuotaUsage(quotaId) {
    fetch(`/lab-admin/quota-allocations/${quotaId}/usage/`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('quotaUsageContent').innerHTML = html;
            new bootstrap.Modal(document.getElementById('quotaUsageModal')).show();
        });
}

function deleteQuota(quotaId) {
    if (confirm('Are you sure you want to delete this quota allocation? This action cannot be undone.')) {
        fetch(`/lab-admin/quota-allocations/${quotaId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Failed to delete quota allocation'));
            }
        });
    }
}
</script>
{% endblock %}